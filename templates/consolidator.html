{% extends "base.html" %}

{% block title %}Consolidateur de donn√©es - Pierre & Vacances Image Checker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/vendor/libs/bootstrap-select/bootstrap-select.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='assets/vendor/libs/select2/select2.css') }}" />
<style>
.category-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e7e7ff;
}

.category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.category-card.selected {
    background-color: #f8f9fa;
    border-color: #696cff;
}

.category-card.selected .check-icon {
    color: #696cff;
    display: block;
}

.category-card:not(.selected) {
    opacity: 0.6;
}

.category-card:not(.selected) .check-icon {
    display: none;
}

.category-card .card-body {
    padding: 1rem;
}

.entry-count {
    font-weight: 600;
    color: #696cff;
}

.category-overview-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e0e0e0;
    background-color: #fafafa;
}

.category-overview-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    background-color: #fff;
}

.category-overview-card.selected {
    background-color: #f8f9fa;
    border-color: #696cff;
}

.category-overview-card.selected .main-check-icon {
    color: #696cff;
    display: block;
}

.category-overview-card:not(.selected) {
    opacity: 0.6;
}

.category-overview-card:not(.selected) .main-check-icon {
    display: none;
}

.category-overview-card .card-body {
    padding: 1.5rem 1rem;
}

.main-entry-count {
    font-size: 1.5rem;
    margin-top: 0.75rem;
    color: #696cff;
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <!-- Information Card -->
    <div class="card mb-4 bg-light">
      <div class="card-body">
        <div class="d-flex align-items-start">
          <div class="flex-shrink-0">
            <div class="avatar avatar-lg me-3">
              <span class="avatar-initial rounded-circle bg-primary">
                <i class="bx bx-info-circle bx-md"></i>
              </span>
            </div>
          </div>
          <div class="flex-grow-1">
            <h5 class="mb-2">√Ä propos du Consolidateur de donn√©es</h5>
            <p class="mb-2">
              Cet outil analyse et consolide toutes les destinations du catalogue Pierre & Vacances en parcourant automatiquement le sitemap principal.
            </p>
            <div class="d-flex align-items-center mb-2">
              <i class="bx bx-link text-primary me-2"></i>
              <span class="text-muted">Source des donn√©es :</span>
              <a href="https://www.pierreetvacances.com/sitemap.xml" target="_blank" class="ms-2">
                https://www.pierreetvacances.com/sitemap.xml
              </a>
            </div>
            <div class="alert alert-info mb-0 mt-3">
              <div class="alert-body d-flex align-items-center">
                <i class="bx bx-bulb me-2"></i>
                <div>
                  <strong>Cat√©gories analys√©es :</strong> Pays (country.xml), R√©gions (region.xml), Destinations (destination.xml), 
                  Zones touristiques (zone-touristique.xml), Fiches produits (fiche-produit.xml), Avis (avis-fiche-produit.xml), 
                  et autres pages (autre-page.xml)
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="bx bx-collection me-2"></i>Consolidateur de donn√©es
        </h5>
        <div>
          <button class="btn btn-info" onclick="createAutoSnapshot()">
            <i class="bx bx-camera me-2"></i>Cr√©er un snapshot
          </button>
          <button class="btn btn-success" onclick="showScrapingOptionsModal()">
            <i class="bx bx-globe me-2"></i>Scraper le catalogue
          </button>
          <button class="btn btn-primary" onclick="showAddDestinationModal()">
            <i class="bx bx-plus me-2"></i>Ajouter une destination
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- Categories Overview Cards -->
        <div class="mb-4">
          <h6 class="text-muted mb-3">Sources de donn√©es disponibles - √âl√©ments v√©rifiables</h6>
          <div class="row" id="main-category-cards">
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card selected" data-category="country" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üåç</span>
                  <h6 class="mt-2 mb-1">Pays</h6>
                  <p class="text-muted small mb-0">country.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="country">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card selected" data-category="region" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üìç</span>
                  <h6 class="mt-2 mb-1">R√©gions</h6>
                  <p class="text-muted small mb-0">region.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="region">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card selected" data-category="destination" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üèñÔ∏è</span>
                  <h6 class="mt-2 mb-1">Destinations</h6>
                  <p class="text-muted small mb-0">destination.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="destination">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card selected" data-category="zone-touristique" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üèùÔ∏è</span>
                  <h6 class="mt-2 mb-1">Zones Tourist.</h6>
                  <p class="text-muted small mb-0">zone-touristique.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="zone-touristique">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card selected" data-category="fiche-produit" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üè®</span>
                  <h6 class="mt-2 mb-1">Fiches Produits</h6>
                  <p class="text-muted small mb-0">fiche-produit.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="fiche-produit">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card" data-category="avis-fiche-produit" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">‚≠ê</span>
                  <h6 class="mt-2 mb-1">Avis</h6>
                  <p class="text-muted small mb-0">avis-fiche-produit.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="avis-fiche-produit">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card" data-category="blog" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üìù</span>
                  <h6 class="mt-2 mb-1">Blog</h6>
                  <p class="text-muted small mb-0">blog.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="blog">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <div class="card h-100 category-overview-card" data-category="autre-page" onclick="toggleMainCategoryCard(this)">
                <div class="card-body text-center">
                  <div class="d-flex justify-content-end mb-1">
                    <i class="bx bx-check-circle fs-5 main-check-icon"></i>
                  </div>
                  <span class="fs-2">üìÑ</span>
                  <h6 class="mt-2 mb-1">Autres Pages</h6>
                  <p class="text-muted small mb-0">autre-page.xml.gz</p>
                  <div class="text-primary fw-semibold main-entry-count" data-category="autre-page">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quick Scraping Actions -->
        <div class="mb-4 text-center">
          <button class="btn btn-success btn-lg" onclick="startQuickScraping()">
            <i class="bx bx-rocket me-2"></i>Scraper les cat√©gories s√©lectionn√©es
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="bx bx-search"></i></span>
              <input type="text" class="form-control" placeholder="Rechercher une destination..." id="search-input" onkeyup="filterDestinations()">
            </div>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="language-filter" onchange="filterDestinations()">
              <option value="">Toutes les langues</option>
              <option value="fr-fr">FR</option>
              <option value="be-wl">BE-WL</option>
              <option value="be-nl">BE-NL</option>
              <option value="nl-nl">NL</option>
              <option value="de-de">DE</option>
              <option value="es-es">ES</option>
              <option value="it-it">IT</option>
              <option value="en-gb">GB</option>
              <option value="fr-ch">CH</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="category-filter" onchange="filterDestinations()">
              <option value="">Toutes cat√©gories</option>
              <option value="destination">üèñÔ∏è Destinations</option>
              <option value="offre">‚ö° Offres</option>
              <option value="editorial">üìù Editorial</option>
              <option value="sejour">üè® S√©jours</option>
            </select>
          </div>
          <div class="col-md-4 text-end">
            <div class="dropdown d-inline-block">
              <button class="btn btn-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bx bx-download"></i> Export
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportDestinations('csv')">Export CSV</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportDestinationsJSON()">Export JSON (offline)</a></li>
              </ul>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="showImportModal()">
              <i class="bx bx-upload"></i> Import CSV
            </button>
            <div class="dropdown d-inline-block">
              <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bx bx-refresh"></i> Re-classifier
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="reclassifyOffline()">
                  <i class="bx bx-shield"></i> Mode Offline (recommand√©)
                </a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="reclassifyCountries()">
                  <i class="bx bx-globe"></i> Mode Online (avec HTTP)
                </a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Progress bar for scraping -->
        <div class="mb-3" id="scraping-progress" style="display: none;">
          <div class="d-flex justify-content-between mb-2">
            <span>Scraping en cours...</span>
            <span id="scraping-status">0%</span>
          </div>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 id="scraping-bar"
                 style="width: 0%">
            </div>
          </div>
          <div class="mt-2">
            <button class="btn btn-danger btn-sm" onclick="stopScraping()">
              <i class="bx bx-stop"></i> Arr√™ter le scraping
            </button>
          </div>
        </div>

        <!-- Progress bar for reclassification -->
        <div class="mb-3" id="reclassify-progress" style="display: none;">
          <div class="d-flex justify-content-between mb-2">
            <span id="reclassify-status-text">Re-classification en cours...</span>
            <span id="reclassify-status-percent">0%</span>
          </div>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                 role="progressbar" 
                 id="reclassify-bar"
                 style="width: 0%">
            </div>
          </div>
          <small class="text-muted mt-1" id="reclassify-current-url">Initialisation...</small>
          <div class="mt-2">
            <button class="btn btn-danger btn-sm" onclick="stopReclassification()">
              <i class="bx bx-stop"></i> Arr√™ter la re-classification
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Category Tabs -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <ul class="nav nav-pills mb-3" id="category-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" type="button" onclick="loadDestinationsByCategory('all')">
              <i class="bx bx-world"></i> All <span class="badge bg-light text-dark ms-1" id="all-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="country-tab" type="button" onclick="loadDestinationsByCategory('country')">
              <i class="bx bx-flag"></i> Pays <span class="badge bg-light text-dark ms-1" id="country-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="region-tab" type="button" onclick="loadDestinationsByCategory('region')">
              <i class="bx bx-map-pin"></i> R√©gions <span class="badge bg-light text-dark ms-1" id="region-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="destination-tab" type="button" onclick="loadDestinationsByCategory('destination')">
              <i class="bx bx-map"></i> Destinations <span class="badge bg-light text-dark ms-1" id="destination-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="zone-touristique-tab" type="button" onclick="loadDestinationsByCategory('zone-touristique')">
              <i class="bx bx-landscape"></i> Zones Tourist. <span class="badge bg-light text-dark ms-1" id="zone-touristique-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="fiche-produit-tab" type="button" onclick="loadDestinationsByCategory('fiche-produit')">
              <i class="bx bx-file"></i> Fiches Produits <span class="badge bg-light text-dark ms-1" id="fiche-produit-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="avis-fiche-produit-tab" type="button" onclick="loadDestinationsByCategory('avis-fiche-produit')">
              <i class="bx bx-star"></i> Avis <span class="badge bg-light text-dark ms-1" id="avis-fiche-produit-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="blog-tab" type="button" onclick="loadDestinationsByCategory('blog')">
              <i class="bx bx-edit"></i> Blog <span class="badge bg-light text-dark ms-1" id="blog-count-tab">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="autre-page-tab" type="button" onclick="loadDestinationsByCategory('autre-page')">
              <i class="bx bx-file-blank"></i> Autres Pages <span class="badge bg-light text-dark ms-1" id="autre-page-count-tab">0</span>
            </button>
          </li>
        </ul>
        <div class="tab-content" id="category-tab-content">
          <div class="tab-pane fade show active" id="all-content" role="tabpanel">
            <div class="mb-3 text-center">
              <button class="btn btn-success" onclick="verifyCurrentSelection()">
                <i class="bx bx-check-double"></i> V√©rifier ces donn√©es
                <span class="badge bg-light text-dark ms-1" id="verify-count">0</span>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Destination</th>
                    <th>Pays</th>
                    <th>Langue</th>
                    <th>Cat√©gorie</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Derni√®re v√©rification</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="destinations-tbody">
                </tbody>
              </table>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <p class="text-muted mb-0">Affichage <span id="showing-start">0</span> - <span id="showing-end">0</span> sur <span id="showing-total">0</span> destinations</p>
              </div>
              <div class="col-md-6">
                <nav aria-label="Page navigation">
                  <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Destination Modal -->
<div class="modal fade" id="destinationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="destinationModalTitle">Ajouter une destination</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="destinationForm">
          <input type="hidden" id="destination-id">
          <div class="mb-3">
            <label for="destination-name" class="form-label">Nom de la destination *</label>
            <input type="text" class="form-control" id="destination-name" required>
          </div>
          <div class="mb-3">
            <label for="destination-url" class="form-label">URL *</label>
            <input type="url" class="form-control" id="destination-url" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="destination-country" class="form-label">Pays *</label>
                <select class="form-select" id="destination-country" required>
                  <option value="">S√©lectionner un pays</option>
                  <option value="FR">France</option>
                  <option value="ES">Espagne</option>
                  <option value="IT">Italie</option>
                  <option value="GR">Gr√®ce</option>
                  <option value="PT">Portugal</option>
                  <option value="MT">Malte</option>
                  <option value="MU">Maurice</option>
                  <option value="RE">R√©union</option>
                  <option value="AD">Andorre</option>
                  <option value="GP">Guadeloupe</option>
                  <option value="MQ">Martinique</option>
                  <option value="BE">Belgique</option>
                  <option value="NL">Pays-Bas</option>
                  <option value="DE">Allemagne</option>
                  <option value="AT">Autriche</option>
                  <option value="CH">Suisse</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="destination-type" class="form-label">Type</label>
                <select class="form-select" id="destination-type">
                  <option value="residence">R√©sidence</option>
                  <option value="hotel">H√¥tel</option>
                  <option value="villa">Villa</option>
                  <option value="appartement">Appartement</option>
                  <option value="camping">Camping</option>
                  <option value="resort">Resort</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="destination-region" class="form-label">R√©gion</label>
                <input type="text" class="form-control" id="destination-region">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="destination-city" class="form-label">Ville</label>
                <input type="text" class="form-control" id="destination-city">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="destination-notes" class="form-label">Notes</label>
            <textarea class="form-control" id="destination-notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="saveDestination()">Sauvegarder</button>
      </div>
    </div>
  </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importer des destinations (CSV)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="csv-file" class="form-label">Fichier CSV</label>
          <input type="file" class="form-control" id="csv-file" accept=".csv">
          <div class="form-text">Format attendu: Nom, URL, Pays, R√©gion, Ville, Type, Notes</div>
        </div>
        <div class="alert alert-info">
          <i class="bx bx-info-circle me-2"></i>
          Le fichier CSV doit contenir les colonnes: Nom, URL, Pays, R√©gion, Ville, Type, Notes
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="importCSV()">Importer</button>
      </div>
    </div>
  </div>
</div>

<!-- Scraping Options Modal -->
<div class="modal fade" id="scrapingOptionsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configuration du Scraping</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h6 class="mb-3">S√©lectionnez les cat√©gories √† scraper depuis le sitemap :</h6>
          <div class="alert alert-info mb-3">
            <i class="bx bx-info-circle me-2"></i>
            Le scraping analyse le sitemap principal pour extraire toutes les destinations selon les cat√©gories s√©lectionn√©es.
          </div>
          
          <!-- Loading indicator -->
          <div id="sitemap-counts-loading" class="text-center mb-3" style="display: none;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <span class="ms-2">R√©cup√©ration du nombre d'entr√©es...</span>
          </div>
          
          <div class="row" id="category-cards">
            <div class="col-md-6 mb-3">
              <div class="card category-card selected" data-category="country" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üåç</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Pays</h6>
                      <small class="text-muted">country.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Pages de niveau pays (ex: France, Espagne, Italie)</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card selected" data-category="region" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üìç</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">R√©gions</h6>
                      <small class="text-muted">region.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">R√©gions administratives (ex: Alsace, Bretagne, Andalousie)</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card selected" data-category="destination" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üèñÔ∏è</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Destinations</h6>
                      <small class="text-muted">destination.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Villes et localit√©s (ex: Nice, Barcelone, Rome)</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card selected" data-category="zone-touristique" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üèùÔ∏è</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Zones Touristiques</h6>
                      <small class="text-muted">zone-touristique.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Zones touristiques (ex: C√¥te d'Azur, Costa del Sol, Majorque)</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card selected" data-category="fiche-produit" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üè®</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Fiches Produits</h6>
                      <small class="text-muted">fiche-produit.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">R√©sidences et h√©bergements individuels</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card" data-category="avis-fiche-produit" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">‚≠ê</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Avis</h6>
                      <small class="text-muted">avis-fiche-produit.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Pages d'avis clients (g√©n√©ralement √† exclure)</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card" data-category="blog" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üìù</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Blog</h6>
                      <small class="text-muted">blog.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Articles de blog et contenus √©ditoriaux</small>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="card category-card" data-category="autre-page" onclick="toggleCategoryCard(this)">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <span class="fs-3 me-2">üìÑ</span>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">Autres Pages</h6>
                      <small class="text-muted">autre-page.xml.gz <span class="entry-count"></span></small>
                    </div>
                    <i class="bx bx-check-circle fs-4 check-icon"></i>
                  </div>
                  <small class="text-muted">Autres types de pages du site</small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-4">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="select-all-categories" checked>
              <label class="form-check-label" for="select-all-categories">
                <strong>S√©lectionner/D√©s√©lectionner tout</strong>
              </label>
            </div>
          </div>
          
          <div class="alert alert-warning mt-3">
            <i class="bx bx-time me-2"></i>
            <strong>Estimation :</strong> Le scraping complet peut prendre entre 5 et 20 minutes selon le nombre de cat√©gories s√©lectionn√©es.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" onclick="startCustomScraping()">
          <i class="bx bx-rocket me-2"></i>Lancer le scraping
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentDestinations = [];
let currentCategory = 'all';
let currentPage = 1;
const destinationsPerPage = 20;

function getLanguageLabel(languageCode) {
    const languages = {
        'fr-fr': 'FR',
        'be-wl': 'BE-WL', 
        'be-nl': 'BE-NL',
        'nl-nl': 'NL',
        'de-de': 'DE',
        'es-es': 'ES',
        'it-it': 'IT',
        'en-gb': 'GB',
        'fr-ch': 'CH'
    };
    return languages[languageCode] || languageCode;
}

function getCategoryBadge(category) {
    const categories = {
        'destination': '<span class="badge bg-label-primary">üèñÔ∏è Destination</span>',
        'offre': '<span class="badge bg-label-warning">‚ö° Offre</span>',
        'editorial': '<span class="badge bg-label-info">üìù Editorial</span>',
        'sejour': '<span class="badge bg-label-success">üè® S√©jour</span>'
    };
    return categories[category] || categories['destination'];
}

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadDestinationsByCategory('all');
    loadCategoryCounts();
    
    // Check if there's an ongoing reclassification and restore the progress bar
    checkReclassifyProgress();
    checkScrapingProgress();
    
    // Toggle all categories cards
    const selectAllCheckbox = document.getElementById('select-all-categories');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const cards = document.querySelectorAll('.category-card');
            cards.forEach(card => {
                if (this.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        });
    }
});

function loadCategoryCounts() {
    // Charger les compteurs pour les cards de la page principale et les onglets
    fetch('/api/consolidator/sitemap-counts')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.counts) {
                let totalCount = 0;
                
                // Mettre √† jour les cards de la page principale et les onglets
                for (const [category, count] of Object.entries(data.counts)) {
                    totalCount += count;
                    
                    // Mettre √† jour les cards principales
                    const countElement = document.querySelector(`.main-entry-count[data-category="${category}"]`);
                    if (countElement) {
                        countElement.textContent = count > 0 ? 
                            `${count.toLocaleString()} entr√©es` : 
                            '0 entr√©e';
                    }
                    
                    // Mettre √† jour les badges des onglets
                    const tabBadge = document.getElementById(`${category}-count-tab`);
                    if (tabBadge) {
                        tabBadge.textContent = count.toLocaleString();
                    }
                }
                
                // Mettre √† jour le badge "All"
                const allTabBadge = document.getElementById('all-count-tab');
                if (allTabBadge) {
                    allTabBadge.textContent = totalCount.toLocaleString();
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des compteurs:', error);
            // En cas d'erreur, afficher un tiret
            document.querySelectorAll('.main-entry-count').forEach(el => {
                el.textContent = '-';
            });
        });
}

function loadDestinationsByCategory(category) {
    currentCategory = category;
    currentPage = 1;
    
    // G√©rer l'√©tat actif des onglets
    document.querySelectorAll('#category-tabs .nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Activer l'onglet appropri√©
    if (category === 'all') {
        document.getElementById('all-tab').classList.add('active');
    } else {
        const categoryTab = document.getElementById(`${category}-tab`);
        if (categoryTab) {
            categoryTab.classList.add('active');
        }
    }
    
    const url = category === 'all' ? '/api/consolidator/destinations' : `/api/consolidator/destinations/category/${category}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Handle both old format (direct array) and new format (object with destinations)
            const destinations = data.destinations || data;
            console.log(`Loaded ${destinations.length} destinations for category: ${category}`);
            currentDestinations = destinations;
            displayDestinations();
            updateVerifyButtonCount();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors du chargement des destinations', 'error');
        });
}

function displayDestinations() {
    const tbody = document.getElementById('destinations-tbody');
    tbody.innerHTML = '';
    
    console.log(`Displaying destinations: ${currentDestinations ? currentDestinations.length : 'undefined'} total`);
    
    if (!currentDestinations || currentDestinations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucune destination trouv√©e</td></tr>';
        updateShowingInfo(0, 0, 0);
        return;
    }
    
    const start = (currentPage - 1) * destinationsPerPage;
    const end = Math.min(start + destinationsPerPage, currentDestinations.length);
    
    console.log(`Showing items ${start + 1} to ${end} of ${currentDestinations.length}`);
    
    for (let i = start; i < end; i++) {
        const dest = currentDestinations[i];
        if (!dest) {
            console.error(`Destination at index ${i} is undefined`);
            continue;
        }
        
        const row = tbody.insertRow();
        
        try {
            const statusBadge = getStatusBadge(dest);
            const lastChecked = dest.last_checked ? 
                new Date(dest.last_checked).toLocaleDateString('fr-FR') : 
                '<span class="text-muted">Jamais</span>';
            
            // Extract language from URL
            const languageMatch = dest.url.match(/\/([a-z]{2}-[a-z]{2})\//);
            const languageCode = languageMatch ? languageMatch[1] : 'N/A';
            const languageLabel = getLanguageLabel(languageCode);
            
            // Get category badge
            const categoryBadge = getCategoryBadge(dest.category || 'destination');
            
            row.innerHTML = `
            <td>
                <strong>${dest.name || 'Nom manquant'}</strong>
                <br><small class="text-muted">${dest.url || 'URL manquante'}</small>
            </td>
            <td>
                <i class="${dest.flag_icon || 'fi-fr'} fis rounded-circle me-1"></i>
                ${dest.country_name || dest.country || 'Pays inconnu'}
            </td>
            <td><span class="badge bg-label-secondary">${languageLabel}</span></td>
            <td>${categoryBadge}</td>
            <td><span class="badge bg-label-info">${dest.type || 'N/A'}</span></td>
            <td>${statusBadge}</td>
            <td>${lastChecked}</td>
            <td>
                <div class="dropdown">
                    <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="javascript:void(0);" onclick="editDestination(${dest.id})">
                            <i class="bx bx-edit me-1"></i> Modifier
                        </a>
                        <a class="dropdown-item" href="${dest.url}" target="_blank">
                            <i class="bx bx-link-external me-1"></i> Visiter
                        </a>
                        <a class="dropdown-item" href="javascript:void(0);" onclick="checkDestination('${dest.url}')">
                            <i class="bx bx-search me-1"></i> V√©rifier images
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="deleteDestination(${dest.id})">
                            <i class="bx bx-trash me-1"></i> Supprimer
                        </a>
                    </div>
                </div>
            </td>
        `;
        } catch (error) {
            console.error(`Error rendering destination ${i}:`, error, dest);
            row.innerHTML = '<td colspan="8" class="text-danger">Erreur d\'affichage pour cette destination</td>';
        }
    }
    
    updatePagination();
    updateShowingInfo(start + 1, end, currentDestinations.length);
}

function getStatusBadge(dest) {
    if (dest.last_checked) {
        if (dest.has_placeholder) {
            return '<span class="badge bg-label-warning"><i class="bx bx-error"></i> Placeholder</span>';
        } else {
            return '<span class="badge bg-label-success"><i class="bx bx-check"></i> OK</span>';
        }
    } else {
        return '<span class="badge bg-label-secondary">Non v√©rifi√©</span>';
    }
}

function updatePagination() {
    const totalPages = Math.ceil(currentDestinations.length / destinationsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    console.log(`updatePagination: totalPages=${totalPages}, currentDestinations.length=${currentDestinations.length}, destinationsPerPage=${destinationsPerPage}`);
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage - 1})">Pr√©c√©dent</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 10); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage + 1})">Suivant</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(currentDestinations.length / destinationsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayDestinations();
    }
}

function updateShowingInfo(start, end, total) {
    console.log(`updateShowingInfo: start=${start}, end=${end}, total=${total}, currentPage=${currentPage}, destinationsPerPage=${destinationsPerPage}`);
    document.getElementById('showing-start').textContent = start;
    document.getElementById('showing-end').textContent = end;
    document.getElementById('showing-total').textContent = total;
}

function filterDestinations() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const languageFilter = document.getElementById('language-filter').value;
    const categoryFilter = document.getElementById('category-filter').value;
    
    if (searchTerm === '' && languageFilter === '' && categoryFilter === '') {
        loadDestinationsByCategory(currentCategory);
    } else {
        // Reload all destinations first to apply filters
        const url = currentCategory === 'all' ? '/api/consolidator/destinations' : `/api/consolidator/destinations/category/${currentCategory}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const allDestinations = data.destinations || data;
                const filtered = allDestinations.filter(dest => {
                    // Search filter
                    const matchesSearch = searchTerm === '' || 
                        dest.name.toLowerCase().includes(searchTerm) || 
                        dest.url.toLowerCase().includes(searchTerm) ||
                        (dest.country_name && dest.country_name.toLowerCase().includes(searchTerm));
                    
                    // Language filter
                    const matchesLanguage = languageFilter === '' || 
                        dest.url.includes(`/${languageFilter}/`);
                    
                    // Category filter
                    const matchesCategory = categoryFilter === '' || 
                        (dest.category || 'destination') === categoryFilter;
                    
                    return matchesSearch && matchesLanguage && matchesCategory;
                });
                
                currentDestinations = filtered;
                currentPage = 1;
                displayDestinations();
            })
            .catch(error => {
                console.error('Erreur lors du filtrage:', error);
            });
    }
}

function startFullScraping() {
    document.getElementById('scraping-progress').style.display = 'block';
    
    fetch('/api/consolidator/scrape-full', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Scraping complet d√©marr√©', 'success');
                // Poll for progress
                checkScrapingProgress();
            } else {
                showAlert(data.error || 'Erreur lors du d√©marrage du scraping', 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
            document.getElementById('scraping-progress').style.display = 'none';
        });
}

function checkScrapingProgress() {
    fetch('/api/consolidator/scraping-status')
        .then(response => response.json())
        .then(data => {
            if (data.is_running) {
                // Show progress bar if it's hidden
                document.getElementById('scraping-progress').style.display = 'block';
                
                const progress = data.progress_percent || 0;
                document.getElementById('scraping-bar').style.width = progress + '%';
                document.getElementById('scraping-status').textContent = Math.round(progress) + '%';
                
                // Update status text if available
                if (data.current_status) {
                    const progressContainer = document.querySelector('#scraping-progress .d-flex span');
                    if (progressContainer) {
                        progressContainer.textContent = data.current_status;
                    }
                }
                
                // Store progress in localStorage for persistence
                localStorage.setItem('scraping_progress', JSON.stringify({
                    progress: progress,
                    status: data.current_status,
                    destinations_found: data.destinations_found,
                    timestamp: Date.now()
                }));
                
                setTimeout(checkScrapingProgress, 1000);
            } else {
                // Clear stored progress when finished
                localStorage.removeItem('scraping_progress');
                
                // Only show final message if we were actually running
                if (document.getElementById('scraping-progress').style.display === 'block') {
                    document.getElementById('scraping-progress').style.display = 'none';
                    const finalMessage = data.current_status || `Scraping termin√©: ${data.destinations_found} destinations trouv√©es`;
                    showAlert(finalMessage, data.destinations_found > 0 ? 'success' : 'warning');
                    loadDestinationsByCategory(currentCategory);
                }
            }
        })
        .catch(() => {
            // Don't hide progress bar on error, just stop polling
        });
}

function showAddDestinationModal() {
    document.getElementById('destinationModalTitle').textContent = 'Ajouter une destination';
    document.getElementById('destinationForm').reset();
    document.getElementById('destination-id').value = '';
    new bootstrap.Modal(document.getElementById('destinationModal')).show();
}

function editDestination(id) {
    const dest = currentDestinations.find(d => d.id === id);
    if (!dest) return;
    
    document.getElementById('destinationModalTitle').textContent = 'Modifier la destination';
    document.getElementById('destination-id').value = dest.id;
    document.getElementById('destination-name').value = dest.name;
    document.getElementById('destination-url').value = dest.url;
    document.getElementById('destination-country').value = dest.country;
    document.getElementById('destination-type').value = dest.type || '';
    document.getElementById('destination-region').value = dest.region || '';
    document.getElementById('destination-city').value = dest.city || '';
    document.getElementById('destination-notes').value = dest.notes || '';
    
    new bootstrap.Modal(document.getElementById('destinationModal')).show();
}

function saveDestination() {
    const form = document.getElementById('destinationForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const data = {
        id: document.getElementById('destination-id').value,
        name: document.getElementById('destination-name').value,
        url: document.getElementById('destination-url').value,
        country: document.getElementById('destination-country').value,
        type: document.getElementById('destination-type').value,
        region: document.getElementById('destination-region').value,
        city: document.getElementById('destination-city').value,
        notes: document.getElementById('destination-notes').value
    };
    
    const url = data.id ? '/api/consolidator/destinations' : '/api/consolidator/destinations';
    const method = data.id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Destination sauvegard√©e avec succ√®s', 'success');
            bootstrap.Modal.getInstance(document.getElementById('destinationModal')).hide();
            loadDestinationsByCategory(currentCategory);
        } else {
            showAlert(result.error || 'Erreur lors de la sauvegarde', 'error');
        }
    });
}

function deleteDestination(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette destination ?')) return;
    
    fetch(`/api/consolidator/destinations/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Destination supprim√©e', 'success');
                loadDestinationsByCategory(currentCategory);
            } else {
                showAlert(result.error || 'Erreur lors de la suppression', 'error');
            }
        });
}

function exportDestinations(format) {
    const url = currentCountry ? 
        `/api/consolidator/export/${format}/${currentCountry}` : 
        `/api/consolidator/export/${format}`;
    
    window.open(url, '_blank');
}

function showImportModal() {
    new bootstrap.Modal(document.getElementById('importModal')).show();
}

function importCSV() {
    const fileInput = document.getElementById('csv-file');
    if (!fileInput.files[0]) {
        showAlert('Veuillez s√©lectionner un fichier CSV', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    fetch('/api/consolidator/import/csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Import r√©ussi: ${result.imported_count} destinations import√©es`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            loadDestinationsByCategory(currentCategory);
        } else {
            showAlert(result.error || 'Erreur lors de l\'import', 'error');
        }
    });
}

function checkDestination(url) {
    // Redirect to image checker with specific URL
    window.location.href = `/?check=${encodeURIComponent(url)}`;
}


function createAutoSnapshot() {
    const now = new Date();
    const versionName = `Auto-${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}h${now.getMinutes().toString().padStart(2, '0')}`;
    
    const data = {
        version_name: versionName,
        description: `Snapshot automatique cr√©√© depuis le consolidateur le ${now.toLocaleDateString('fr-FR')} √† ${now.toLocaleTimeString('fr-FR')}`,
        created_by: 'Consolidateur'
    };
    
    fetch('/api/consolidator/snapshots', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert(`Snapshot "${versionName}" cr√©√© avec succ√®s`, 'success');
        } else {
            showAlert(result.error || 'Erreur lors de la cr√©ation du snapshot', 'error');
        }
    })
    .catch(error => {
        showAlert('Erreur: ' + error, 'error');
    });
}

function cleanupAvisUrls() {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer toutes les URLs contenant "/avis" ?')) {
        return;
    }
    
    fetch('/api/consolidator/cleanup/avis', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(`${result.deleted_count} URLs d'avis supprim√©es avec succ√®s`, 'success');
                loadDestinationsByCategory(currentCategory);
            } else {
                showAlert(result.error || 'Erreur lors du nettoyage', 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
        });
}

function reclassifyCountries() {
    if (!confirm('√ätes-vous s√ªr de vouloir re-classifier toutes les destinations (pays ET cat√©gories) ?\n\nCela utilisera les correspondances configur√©es dans les Param√®tres avec threading 30x30.')) {
        return;
    }
    
    document.getElementById('reclassify-progress').style.display = 'block';
    
    fetch('/api/consolidator/reclassify-countries', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Re-classification d√©marr√©e (threading 30x30)', 'success');
                // Poll for progress
                checkReclassifyProgress();
            } else {
                showAlert(result.error || 'Erreur lors du d√©marrage de la re-classification', 'error');
                document.getElementById('reclassify-progress').style.display = 'none';
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
            document.getElementById('reclassify-progress').style.display = 'none';
        });
}

function stopScraping() {
    if (!confirm('√ätes-vous s√ªr de vouloir arr√™ter le scraping en cours ?')) {
        return;
    }
    
    fetch('/api/consolidator/stop-scraping', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Scraping arr√™t√©', 'info');
                document.getElementById('scraping-progress').style.display = 'none';
            } else {
                showAlert('Erreur lors de l\'arr√™t du scraping', 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
        });
}

function checkReclassifyProgress() {
    fetch('/api/consolidator/reclassify-status')
        .then(response => response.json())
        .then(data => {
            console.log('Reclassify status:', data);
            
            if (data.is_running) {
                // Show progress bar if it's hidden
                document.getElementById('reclassify-progress').style.display = 'block';
                
                const progress = data.progress_percent || 0;
                document.getElementById('reclassify-bar').style.width = progress + '%';
                document.getElementById('reclassify-status-percent').textContent = Math.round(progress) + '%';
                
                // Update status text
                if (data.current_status) {
                    document.getElementById('reclassify-status-text').textContent = data.current_status;
                }
                
                // Update current URL being processed
                if (data.current_url) {
                    document.getElementById('reclassify-current-url').textContent = 
                        `${data.updated_count} mis √† jour - URL: ${data.current_url}`;
                } else {
                    document.getElementById('reclassify-current-url').textContent = 
                        `${data.updated_count} destinations mises √† jour`;
                }
                
                // Store progress in localStorage for persistence
                localStorage.setItem('reclassify_progress', JSON.stringify({
                    progress: progress,
                    status: data.current_status,
                    updated_count: data.updated_count,
                    timestamp: Date.now()
                }));
                
                setTimeout(checkReclassifyProgress, 1000); // 1 seconde
            } else {
                // Clear stored progress when finished
                localStorage.removeItem('reclassify_progress');
                
                // Only show final message and reload if we were actually running
                if (document.getElementById('reclassify-progress').style.display === 'block') {
                    document.getElementById('reclassify-progress').style.display = 'none';
                    const finalMessage = data.current_status || `Re-classification termin√©e: ${data.updated_count} destinations mises √† jour`;
                    
                    // Only show success/info alerts, not error messages on page load
                    if (!data.current_status || !data.current_status.includes('Erreur')) {
                        showAlert(finalMessage, data.updated_count > 0 ? 'success' : 'info');
                    }
                    
                    // Reload data
                    loadDestinationsByCategory(currentCategory);
                }
            }
        })
        .catch(error => {
            console.error('Erreur polling reclassify status:', error);
            // Don't hide progress bar on error, just stop polling
        });
}


function stopReclassification() {
    if (!confirm('√ätes-vous s√ªr de vouloir arr√™ter la re-classification en cours ?')) {
        return;
    }
    
    fetch('/api/consolidator/stop-reclassification', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Re-classification arr√™t√©e', 'info');
                document.getElementById('reclassify-progress').style.display = 'none';
            } else {
                showAlert('Erreur lors de l\'arr√™t de la re-classification', 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
        });
}

function exportDestinationsJSON() {
    showAlert('Export JSON en cours...', 'info');
    
    fetch('/api/consolidator/export/json')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(`‚úÖ ${result.message}`, 'success');
                // Optionnellement, t√©l√©charger le fichier
                if (confirm('Voulez-vous t√©l√©charger le fichier JSON export√© ?')) {
                    window.open(result.filename, '_blank');
                }
            } else {
                showAlert('Erreur lors de l\'export JSON: ' + result.error, 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
        });
}

function reclassifyOffline() {
    if (!confirm('Lancer la re-classification en mode OFFLINE ?\n\nCe mode:\n‚úÖ N\'envoie aucune requ√™te HTTP\n‚úÖ Utilise uniquement les donn√©es locales\n‚úÖ Est beaucoup plus rapide\n‚úÖ Ne risque pas de blacklist\n\nRecommand√© pour re-classifier les cat√©gories.')) {
        return;
    }
    
    fetch('/api/consolidator/reclassify-offline', { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(result.message, 'success');
                document.getElementById('reclassify-progress').style.display = 'block';
                pollReclassifyStatus();
            } else {
                showAlert(result.error || 'Erreur lors du lancement', 'error');
            }
        })
        .catch(error => {
            showAlert('Erreur: ' + error, 'error');
        });
}

function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'info' ? 'alert-info' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-xxl');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

function showScrapingOptionsModal() {
    const modal = new bootstrap.Modal(document.getElementById('scrapingOptionsModal'));
    modal.show();
    
    // Afficher le loading
    document.getElementById('sitemap-counts-loading').style.display = 'block';
    
    // Charger les compteurs de chaque sitemap
    fetch('/api/consolidator/sitemap-counts')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.counts) {
                // Mettre √† jour les labels avec les compteurs
                updateCategoryLabels(data.counts);
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des compteurs:', error);
        })
        .finally(() => {
            // Cacher le loading
            document.getElementById('sitemap-counts-loading').style.display = 'none';
        });
}

function updateCategoryLabels(counts) {
    for (const [category, count] of Object.entries(counts)) {
        const card = document.querySelector(`[data-category="${category}"]`);
        if (card) {
            const entryCountSpan = card.querySelector('.entry-count');
            if (entryCountSpan) {
                const countText = count > 0 ? 
                    `- ${count.toLocaleString()} entr√©es` : 
                    '- 0 entr√©e';
                entryCountSpan.textContent = countText;
            }
        }
    }
}

function toggleCategoryCard(card) {
    card.classList.toggle('selected');
    updateSelectAllCheckbox();
}

function updateSelectAllCheckbox() {
    const allCards = document.querySelectorAll('.category-card');
    const selectedCards = document.querySelectorAll('.category-card.selected');
    const selectAllCheckbox = document.getElementById('select-all-categories');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCards.length === selectedCards.length;
    }
}

function toggleMainCategoryCard(card) {
    card.classList.toggle('selected');
}

function selectAllMainCards() {
    const cards = document.querySelectorAll('.category-overview-card');
    cards.forEach(card => {
        card.classList.add('selected');
    });
}

function deselectAllMainCards() {
    const cards = document.querySelectorAll('.category-overview-card');
    cards.forEach(card => {
        card.classList.remove('selected');
    });
}

function startQuickScraping() {
    // Collect selected categories from main cards
    const categories = [];
    const selectedCards = document.querySelectorAll('.category-overview-card.selected');
    
    selectedCards.forEach(card => {
        categories.push(card.dataset.category);
    });
    
    if (categories.length === 0) {
        showAlert('Veuillez s√©lectionner au moins une cat√©gorie √† scraper', 'error');
        return;
    }
    
    // Show progress bar
    document.getElementById('scraping-progress').style.display = 'block';
    
    // Start scraping with selected categories
    fetch('/api/consolidator/scrape-full', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories: categories })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Scraping d√©marr√© pour ${categories.length} cat√©gories s√©lectionn√©es`, 'success');
            checkScrapingProgress();
        } else {
            showAlert(data.error || 'Erreur lors du d√©marrage du scraping', 'error');
            document.getElementById('scraping-progress').style.display = 'none';
        }
    })
    .catch(error => {
        showAlert('Erreur: ' + error, 'error');
        document.getElementById('scraping-progress').style.display = 'none';
    });
}


function startCustomScraping() {
    // Collect selected categories from cards
    const categories = [];
    const selectedCards = document.querySelectorAll('.category-card.selected');
    
    selectedCards.forEach(card => {
        categories.push(card.dataset.category);
    });
    
    if (categories.length === 0) {
        showAlert('Veuillez s√©lectionner au moins une cat√©gorie √† scraper', 'error');
        return;
    }
    
    // Hide modal
    bootstrap.Modal.getInstance(document.getElementById('scrapingOptionsModal')).hide();
    
    // Show progress bar
    document.getElementById('scraping-progress').style.display = 'block';
    
    // Start scraping with selected categories
    fetch('/api/consolidator/scrape-full', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories: categories })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Scraping d√©marr√© pour les cat√©gories s√©lectionn√©es', 'success');
            checkScrapingProgress();
        } else {
            showAlert(data.error || 'Erreur lors du d√©marrage du scraping', 'error');
            document.getElementById('scraping-progress').style.display = 'none';
        }
    })
    .catch(error => {
        showAlert('Erreur: ' + error, 'error');
        document.getElementById('scraping-progress').style.display = 'none';
    });
}

// Variable globale pour stocker les compteurs totaux du pays actuel
let countryCategoryCounts = {
    total: 0,
    destination: 0,
    offre: 0,
    editorial: 0,
    sejour: 0
};

function updateCategorySubcounts(destinations, isFiltered = false) {
    if (!isFiltered) {
        // Si ce n'est pas filtr√©, calculer et stocker les vrais totaux
        countryCategoryCounts = {
            total: destinations.length,
            destination: 0,
            offre: 0,
            editorial: 0,
            sejour: 0
        };
        
        destinations.forEach((dest) => {
            const category = dest.category || 'destination';
            
            if (countryCategoryCounts.hasOwnProperty(category)) {
                countryCategoryCounts[category]++;
            } else {
                countryCategoryCounts.destination++; // Default to destination for unknown categories
            }
        });
    }
    
    // Toujours afficher les totaux du pays, pas les r√©sultats filtr√©s
    document.getElementById('all-count').textContent = countryCategoryCounts.total;
    document.getElementById('dest-count').textContent = countryCategoryCounts.destination;
    document.getElementById('offre-count').textContent = countryCategoryCounts.offre;
    document.getElementById('editorial-count').textContent = countryCategoryCounts.editorial;
    document.getElementById('sejour-count').textContent = countryCategoryCounts.sejour;
    
    // Show/hide subcounts based on whether we have destinations
    const hasDestinations = countryCategoryCounts.total > 0;
    document.getElementById('category-subcounts').style.display = hasDestinations ? 'block' : 'none';
    
    // Reset category filter card highlights
    document.querySelectorAll('.category-filter-card').forEach(card => {
        card.classList.remove('bg-light');
    });
    
    // Highlight active filter if any
    const activeFilter = document.getElementById('category-filter').value;
    if (activeFilter) {
        // Find the corresponding card and highlight it
        document.querySelectorAll('.category-filter-card').forEach(card => {
            if (card.onclick && card.onclick.toString().includes(`'${activeFilter}'`)) {
                card.classList.add('bg-light');
            }
        });
    }
}

function filterByCategory(category) {
    // Set the category filter dropdown
    document.getElementById('category-filter').value = category;
    
    // Highlight the selected category card
    document.querySelectorAll('.category-filter-card').forEach(card => {
        card.classList.remove('bg-light');
    });
    
    // Find and highlight the clicked card
    const clickedCard = event.currentTarget;
    clickedCard.classList.add('bg-light');
    
    // Apply the filter
    filterDestinations();
}

function clearCategoryFilter() {
    // Clear the category filter
    document.getElementById('category-filter').value = '';
    
    // Remove highlights from category cards
    document.querySelectorAll('.category-filter-card').forEach(card => {
        card.classList.remove('bg-light');
    });
    
    // Highlight the "Toutes" card
    document.querySelectorAll('.category-filter-card').forEach(card => {
        if (card.onclick && card.onclick.toString().includes('clearCategoryFilter')) {
            card.classList.add('bg-light');
        }
    });
    
    // Apply the filter
    filterDestinations();
}

function verifyCurrentSelection() {
    // Get current category and count
    const activeTab = document.querySelector('#category-tabs .nav-link.active');
    const category = activeTab ? activeTab.id.replace('-tab', '') : 'all';
    const count = currentDestinations ? currentDestinations.length : 0;
    
    // Build URL parameters
    const params = new URLSearchParams({
        from: 'consolidator',
        category: category,
        count: count
    });
    
    // Redirect to main page with parameters
    window.location.href = `/?${params.toString()}`;
}

// Update verify button count when destinations change
function updateVerifyButtonCount() {
    const count = currentDestinations ? currentDestinations.length : 0;
    document.getElementById('verify-count').textContent = count;
}
</script>
{% endblock %}